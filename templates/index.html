<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataAnalyzer Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --accent: #4895ef;
            --dark: #1b263b;
            --light: #f8f9fa;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f72585;
            --gray: #adb5bd;
            --dark-gray: #495057;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: #f5f7ff;
            color: var(--dark);
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(135deg, var(--dark), #2a3a5a);
            color: white;
            padding: 1.5rem;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--accent);
        }

        .logo h1 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray);
            margin-bottom: 1rem;
            padding-left: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            padding: 2rem;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header h2 {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .data-source {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }

        /* Panel Styles */
        .panel {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        /* Upload Box */
        .upload-box {
            border: 2px dashed var(--gray);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background-color: rgba(248, 249, 250, 0.5);
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .upload-box i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-box h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .upload-box p {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }

        /* Dataset Selector */
        .dataset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .dataset-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dataset-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .dataset-card i {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
        }

        .dataset-card h4 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }

        .dataset-card p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .data-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tr:hover {
            background-color: #f1f1f1;
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background-color: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--dark);
            font-weight: 500;
        }

        /* Data Cleaning */
        .cleaning-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .cleaning-card {
            background-color: white;
            border-radius: 10px;
            padding: 1.2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
        }

        .cleaning-card:hover {
            border-color: var(--primary);
        }

        .cleaning-card.active {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .cleaning-card h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cleaning-card p {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Filter Builder */
        .filter-builder {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1rem;
        }

        .filter-preview {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .app-container {
                grid-template-columns: 80px 1fr;
            }

            .logo h1, .nav-title span, .nav-item span {
                display: none;
            }

            .logo i, .nav-title i {
                font-size: 1.5rem;
                margin-right: 0;
            }

            .nav-item {
                justify-content: center;
                padding: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
                <h1>DataAnalyzer</h1>
            </div>

            <nav>
                <div class="nav-section">
                    <div class="nav-title">
                        <i class="fas fa-database"></i>
                        <span>Datos</span>
                    </div>
                    <div class="nav-item active" data-action="load-data">
                        <i class="fas fa-upload"></i>
                        <span>Cargar Datos</span>
                    </div>
                    <div class="nav-item" data-action="clean-data">
                        <i class="fas fa-broom"></i>
                        <span>Limpieza de Datos</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">
                        <i class="fas fa-wrench"></i>
                        <span>Preparación</span>
                    </div>
                    <div class="nav-item" data-action="show-head">
                        <i class="fas fa-angle-double-up"></i>
                        <span>Primeras Filas</span>
                    </div>
                    <div class="nav-item" data-action="show-tail">
                        <i class="fas fa-angle-double-down"></i>
                        <span>Últimas Filas</span>
                    </div>
                    <div class="nav-item" data-action="show-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Información</span>
                    </div>
                    <div class="nav-item" data-action="show-describe">
                        <i class="fas fa-chart-bar"></i>
                        <span>Estadísticas</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">
                        <i class="fas fa-filter"></i>
                        <span>Análisis</span>
                    </div>
                    <div class="nav-item" data-action="select-column">
                        <i class="fas fa-columns"></i>
                        <span>Seleccionar Columna</span>
                    </div>
                    <div class="nav-item" data-action="filter-data">
                        <i class="fas fa-search"></i>
                        <span>Filtrar Datos</span>
                    </div>
                    <div class="nav-item" data-action="visualize-data">
                        <i class="fas fa-chart-pie"></i>
                        <span>Visualización</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h2 id="panel-title">Cargar Datos</h2>
                <div class="data-source" id="data-source-info" style="display: none;">
                    <span id="current-dataset"></span>
                    <button class="btn btn-outline" id="change-dataset">
                        <i class="fas fa-sync-alt"></i> Cambiar
                    </button>
                </div>
            </div>

            <!-- Load Data Panel -->
            <div class="panel" id="load-data-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="upload">Subir CSV</div>
                    <div class="tab" data-tab="datasets">Datasets</div>
                </div>

                <!-- Upload CSV Tab -->
                <div id="upload-tab">
                    <div class="upload-box" id="upload-box">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Arrastra tu archivo CSV aquí</h3>
                        <p>o</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-folder-open"></i> Seleccionar archivo
                        </button>
                        <input type="file" id="file-input" accept=".csv" style="display: none;">
                    </div>
                </div>

                <!-- Datasets Tab -->
                <div id="datasets-tab" style="display: none;">
                    <h3 class="panel-title">Datasets Predefinidos</h3>
                    <p class="panel-subtitle">Selecciona uno de nuestros datasets de ejemplo</p>

                    <div class="dataset-grid">
                        <div class="dataset-card" data-dataset="iris">
                            <i class="fas fa-seedling"></i>
                            <h4>Iris</h4>
                            <p>150 flores × 5 columnas</p>
                        </div>
                        <div class="dataset-card" data-dataset="tips">
                            <i class="fas fa-utensils"></i>
                            <h4>Tips</h4>
                            <p>244 registros × 7 columnas</p>
                        </div>
                        <div class="dataset-card" data-dataset="titanic">
                            <i class="fas fa-ship"></i>
                            <h4>Titanic</h4>
                            <p>891 pasajeros × 15 columnas</p>
                        </div>
                        <div class="dataset-card" data-dataset="mpg">
                            <i class="fas fa-car"></i>
                            <h4>MPG</h4>
                            <p>398 autos × 9 columnas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Preview Panel -->
            <div class="panel" id="data-preview-panel" style="display: none;">
                <div class="panel-header">
                    <h3 class="panel-title" id="preview-title">Vista Previa</h3>
                    <div>
                        <button class="btn btn-outline" id="show-stats">
                            <i class="fas fa-chart-pie"></i> Estadísticas
                        </button>
                    </div>
                </div>

                <div class="stats-container" id="stats-container" style="display: none;">
                    <!-- Stats cards will be inserted here -->
                </div>

                <div class="table-responsive">
                    <table class="data-table" id="data-table">
                        <!-- Table content will be inserted here -->
                    </table>
                </div>
            </div>

            <!-- Configuration Panel -->
            <div class="panel" id="config-panel" style="display: none;">
                <div class="panel-header">
                    <h3 class="panel-title" id="config-title">Configuración</h3>
                </div>

                <form id="config-form">
                    <!-- Form fields will be inserted here -->
                </form>

                <div class="form-actions">
                    <button class="btn btn-outline" id="cancel-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" id="execute-btn">
                        <i class="fas fa-play"></i> Ejecutar
                    </button>
                </div>
            </div>

            <!-- Data Cleaning Panel -->
            <div class="panel" id="clean-data-panel" style="display: none;">
                <div class="panel-header">
                    <h3 class="panel-title">Limpieza de Datos</h3>
                </div>

                <div class="cleaning-options" id="cleaning-options">
                    <div class="cleaning-card" data-action="fill-na">
                        <h4><i class="fas fa-fill-drip"></i> Rellenar valores faltantes</h4>
                        <p>Reemplaza valores nulos o faltantes con un valor específico</p>
                    </div>
                    <div class="cleaning-card" data-action="drop-na">
                        <h4><i class="fas fa-trash-alt"></i> Eliminar filas con valores faltantes</h4>
                        <p>Remueve filas que contengan valores nulos o faltantes</p>
                    </div>
                    <div class="cleaning-card" data-action="drop-duplicates">
                        <h4><i class="fas fa-clone"></i> Eliminar duplicados</h4>
                        <p>Remueve filas duplicadas del dataset</p>
                    </div>
                    <div class="cleaning-card" data-action="convert-types">
                        <h4><i class="fas fa-exchange-alt"></i> Convertir tipos de datos</h4>
                        <p>Cambia el tipo de datos de una columna específica</p>
                    </div>
                </div>

                <div id="cleaning-form-container" style="display: none;">
                    <form id="cleaning-form">
                        <!-- Form fields will be inserted here -->
                    </form>

                    <div class="form-actions">
                        <button class="btn btn-outline" id="cancel-cleaning-btn">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button class="btn btn-primary" id="apply-cleaning-btn">
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Visualization Panel -->
            <div class="panel" id="visualization-panel" style="display: none;">
                <div class="panel-header">
                    <h3 class="panel-title">Visualización de Datos</h3>
                </div>

                <form id="visualization-form">
                    <div class="form-group">
                        <label>Tipo de gráfico:</label>
                        <select class="form-control" name="chart-type" id="chart-type">
                            <option value="histogram">Histograma</option>
                            <option value="bar">Gráfico de Barras</option>
                            <option value="line">Gráfico de Líneas</option>
                            <option value="pie">Gráfico de Torta</option>
                            <option value="scatter">Gráfico de Dispersión</option>
                            <option value="box">Diagrama de Caja</option>
                        </select>
                    </div>

                    <div class="form-group" id="x-axis-group">
                        <label>Eje X:</label>
                        <select class="form-control" name="x-axis" id="x-axis">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group" id="y-axis-group" style="display: none;">
                        <label>Eje Y:</label>
                        <select class="form-control" name="y-axis" id="y-axis">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-group" id="color-group" style="display: none;">
                        <label>Color por:</label>
                        <select class="form-control" name="color-by" id="color-by">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </form>

                <div class="chart-container">
                    <canvas id="data-chart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const navItems = document.querySelectorAll('.nav-item');
            const tabs = document.querySelectorAll('.tab');
            const fileInput = document.getElementById('file-input');
            const uploadBox = document.getElementById('upload-box');
            const datasetCards = document.querySelectorAll('.dataset-card');
            const loadDataPanel = document.getElementById('load-data-panel');
            const dataPreviewPanel = document.getElementById('data-preview-panel');
            const configPanel = document.getElementById('config-panel');
            const cleanDataPanel = document.getElementById('clean-data-panel');
            const visualizationPanel = document.getElementById('visualization-panel');
            const panelTitle = document.getElementById('panel-title');
            const dataSourceInfo = document.getElementById('data-source-info');
            const currentDataset = document.getElementById('current-dataset');
            const changeDatasetBtn = document.getElementById('change-dataset');
            const showStatsBtn = document.getElementById('show-stats');
            const statsContainer = document.getElementById('stats-container');
            const dataTable = document.getElementById('data-table');
            const configForm = document.getElementById('config-form');
            const executeBtn = document.getElementById('execute-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const previewTitle = document.getElementById('preview-title');
            const cleaningCards = document.querySelectorAll('.cleaning-card');
            const cleaningFormContainer = document.getElementById('cleaning-form-container');
            const cleaningForm = document.getElementById('cleaning-form');
            const applyCleaningBtn = document.getElementById('apply-cleaning-btn');
            const cancelCleaningBtn = document.getElementById('cancel-cleaning-btn');
            const chartTypeSelect = document.getElementById('chart-type');
            const xAxisSelect = document.getElementById('x-axis');
            const yAxisSelect = document.getElementById('y-axis');
            const colorBySelect = document.getElementById('color-by');
            const xAxisGroup = document.getElementById('x-axis-group');
            const yAxisGroup = document.getElementById('y-axis-group');
            const colorGroup = document.getElementById('color-group');
            const chartCanvas = document.getElementById('data-chart');
            
            // State
            let currentData = null;
            let currentAction = 'load-data';
            let currentSource = null;
            let dataChart = null;
            let cleaningAction = null;

            // Event Listeners
            navItems.forEach(item => item.addEventListener('click', handleNavItemClick));
            tabs.forEach(tab => tab.addEventListener('click', handleTabChange));
            fileInput.addEventListener('change', handleFileUpload);
            uploadBox.addEventListener('click', () => fileInput.click());
            datasetCards.forEach(card => card.addEventListener('click', handleDatasetSelect));
            changeDatasetBtn.addEventListener('click', handleChangeDataset);
            showStatsBtn.addEventListener('click', toggleStats);
            executeBtn.addEventListener('click', handleExecute);
            cancelBtn.addEventListener('click', handleCancel);
            cleaningCards.forEach(card => card.addEventListener('click', handleCleaningCardClick));
            applyCleaningBtn.addEventListener('click', handleApplyCleaning);
            cancelCleaningBtn.addEventListener('click', handleCancelCleaning);
            chartTypeSelect.addEventListener('change', updateChartControls);
            xAxisSelect.addEventListener('change', updateChart);
            yAxisSelect.addEventListener('change', updateChart);
            colorBySelect.addEventListener('change', updateChart);

            // Functions
            function handleNavItemClick(e) {
                const action = this.getAttribute('data-action');
                
                // Update active nav item
                navItems.forEach(item => item.classList.remove('active'));
                this.classList.add('active');
                
                currentAction = action;
                panelTitle.textContent = this.querySelector('span').textContent;

                if (action === 'load-data') {
                    loadDataPanel.style.display = 'block';
                    dataPreviewPanel.style.display = 'none';
                    configPanel.style.display = 'none';
                    cleanDataPanel.style.display = 'none';
                    visualizationPanel.style.display = 'none';
                } else if (action === 'clean-data') {
                    loadDataPanel.style.display = 'none';
                    dataPreviewPanel.style.display = 'none';
                    configPanel.style.display = 'none';
                    cleanDataPanel.style.display = 'block';
                    visualizationPanel.style.display = 'none';
                    showCleaningOptions();
                } else if (action === 'visualize-data') {
                    if (!currentData) {
                        alert('Por favor, carga un dataset primero');
                        document.querySelector('[data-action="load-data"]').click();
                        return;
                    }
                    loadDataPanel.style.display = 'none';
                    dataPreviewPanel.style.display = 'none';
                    configPanel.style.display = 'none';
                    cleanDataPanel.style.display = 'none';
                    visualizationPanel.style.display = 'block';
                    setupVisualizationPanel();
                } else if (currentData) {
                    showConfigPanel(action);
                } else {
                    alert('Por favor, carga un dataset primero');
                    document.querySelector('[data-action="load-data"]').click();
                }
            }

            function handleTabChange() {
                tabs.forEach(tab => tab.classList.remove('active'));
                this.classList.add('active');

                if (this.getAttribute('data-tab') === 'upload') {
                    document.getElementById('upload-tab').style.display = 'block';
                    document.getElementById('datasets-tab').style.display = 'none';
                } else {
                    document.getElementById('upload-tab').style.display = 'none';
                    document.getElementById('datasets-tab').style.display = 'block';
                }
            }

            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const df = parseCSV(data);
                        currentData = df;
                        currentSource = file.name;
                        updateUIAfterLoad();
                    } catch (error) {
                        alert('Error al leer el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function handleDatasetSelect() {
                const datasetName = this.getAttribute('data-dataset');
                
                // Simulamos la carga de datos (en una app real harías una petición al servidor)
                const sampleData = {
                    'iris': {
                        columns: ['sepal_length', 'sepal_width', 'petal_length', 'petal_width', 'species'],
                        data: [
                            [5.1, 3.5, 1.4, 0.2, 'setosa'],
                            [4.9, 3.0, 1.4, 0.2, 'setosa'],
                            [4.7, 3.2, 1.3, 0.2, 'setosa'],
                            [4.6, 3.1, 1.5, 0.2, 'setosa'],
                            [5.0, 3.6, 1.4, 0.2, 'setosa'],
                            [5.4, 3.9, 1.7, 0.4, 'setosa'],
                            [4.6, 3.4, 1.4, 0.3, 'setosa'],
                            [5.0, 3.4, 1.5, 0.2, 'setosa'],
                            [4.4, 2.9, 1.4, 0.2, 'setosa'],
                            [4.9, 3.1, 1.5, 0.1, 'setosa'],
                            [7.0, 3.2, 4.7, 1.4, 'versicolor'],
                            [6.4, 3.2, 4.5, 1.5, 'versicolor'],
                            [6.9, 3.1, 4.9, 1.5, 'versicolor'],
                            [5.5, 2.3, 4.0, 1.3, 'versicolor'],
                            [6.5, 2.8, 4.6, 1.5, 'versicolor'],
                            [5.7, 2.8, 4.5, 1.3, 'versicolor'],
                            [6.3, 3.3, 4.7, 1.6, 'versicolor'],
                            [4.9, 2.4, 3.3, 1.0, 'versicolor'],
                            [6.6, 2.9, 4.6, 1.3, 'versicolor'],
                            [5.2, 2.7, 3.9, 1.4, 'versicolor']
                        ]
                    },
                    'tips': {
                        columns: ['total_bill', 'tip', 'sex', 'smoker', 'day', 'time', 'size'],
                        data: [
                            [16.99, 1.01, 'Female', 'No', 'Sun', 'Dinner', 2],
                            [10.34, 1.66, 'Male', 'No', 'Sun', 'Dinner', 3],
                            [21.01, 3.50, 'Male', 'No', 'Sun', 'Dinner', 3],
                            [23.68, 3.31, 'Male', 'No', 'Sun', 'Dinner', 2],
                            [24.59, 3.61, 'Female', 'No', 'Sun', 'Dinner', 4],
                            [25.29, 4.71, 'Male', 'No', 'Sun', 'Dinner', 4],
                            [8.77, 2.00, 'Male', 'No', 'Sun', 'Dinner', 2],
                            [26.88, 3.12, 'Male', 'No', 'Sun', 'Dinner', 4],
                            [15.04, 1.96, 'Male', 'No', 'Sun', 'Dinner', 2],
                            [14.78, 3.23, 'Male', 'No', 'Sun', 'Dinner', 2]
                        ]
                    },
                    'titanic': {
                        columns: ['survived', 'pclass', 'sex', 'age', 'sibsp', 'parch', 'fare', 'embarked', 'class', 'who', 'adult_male', 'deck', 'embark_town', 'alive', 'alone'],
                        data: [
                            [0, 3, 'male', 22.0, 1, 0, 7.25, 'S', 'Third', 'man', true, null, 'Southampton', 'no', false],
                            [1, 1, 'female', 38.0, 1, 0, 71.2833, 'C', 'First', 'woman', false, 'C', 'Cherbourg', 'yes', false],
                            [1, 3, 'female', 26.0, 0, 0, 7.925, 'S', 'Third', 'woman', false, null, 'Southampton', 'yes', true],
                            [1, 1, 'female', 35.0, 1, 0, 53.1, 'S', 'First', 'woman', false, 'C', 'Southampton', 'yes', false],
                            [0, 3, 'male', 35.0, 0, 0, 8.05, 'S', 'Third', 'man', true, null, 'Southampton', 'no', true]
                        ]
                    },
                    'mpg': {
                        columns: ['mpg', 'cylinders', 'displacement', 'horsepower', 'weight', 'acceleration', 'model_year', 'origin', 'name'],
                        data: [
                            [18.0, 8, 307.0, 130, 3504, 12.0, 70, 1, 'chevrolet chevelle malibu'],
                            [15.0, 8, 350.0, 165, 3693, 11.5, 70, 1, 'buick skylark 320'],
                            [18.0, 8, 318.0, 150, 3436, 11.0, 70, 1, 'plymouth satellite'],
                            [16.0, 8, 304.0, 150, 3433, 12.0, 70, 1, 'amc rebel sst'],
                            [17.0, 8, 302.0, 140, 3449, 10.5, 70, 1, 'ford torino']
                        ]
                    }
                };

                currentData = sampleData[datasetName] || sampleData['iris'];
                currentSource = `Dataset: ${datasetName}`;
                updateUIAfterLoad();
            }

            function updateUIAfterLoad() {
                loadDataPanel.style.display = 'none';
                dataPreviewPanel.style.display = 'block';
                configPanel.style.display = 'none';
                cleanDataPanel.style.display = 'none';
                visualizationPanel.style.display = 'none';
                
                dataSourceInfo.style.display = 'flex';
                currentDataset.textContent = currentSource;
                
                // Mostrar las primeras filas por defecto
                showDataPreview(currentData);
            }

            function showDataPreview(data) {
                previewTitle.textContent = 'Vista Previa (' + currentSource + ')';
                
                // Limpiar tabla
                dataTable.innerHTML = '';
                
                // Crear encabezados
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                data.columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                dataTable.appendChild(thead);
                
                // Crear cuerpo de la tabla
                const tbody = document.createElement('tbody');
                
                data.data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                dataTable.appendChild(tbody);
            }

            function showConfigPanel(action) {
                loadDataPanel.style.display = 'none';
                dataPreviewPanel.style.display = 'none';
                configPanel.style.display = 'block';
                cleanDataPanel.style.display = 'none';
                visualizationPanel.style.display = 'none';
                
                // Limpiar formulario
                configForm.innerHTML = '';
                
                // Configurar según la acción
                let title = '';
                let html = '';
                
                switch(action) {
                    case 'show-head':
                        title = 'Mostrar primeras filas';
                        html = `
                            <div class="form-group">
                                <label>Número de filas:</label>
                                <input type="number" class="form-control" name="rows" value="10" min="1">
                            </div>
                        `;
                        break;
                        
                    case 'show-tail':
                        title = 'Mostrar últimas filas';
                        html = `
                            <div class="form-group">
                                <label>Número de filas:</label>
                                <input type="number" class="form-control" name="rows" value="10" min="1">
                            </div>
                        `;
                        break;
                        
                    case 'select-column':
                        title = 'Seleccionar columna';
                        html = `
                            <div class="form-group">
                                <label>Columna:</label>
                                <select class="form-control" name="column">
                                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'filter-data':
                        title = 'Filtrar datos';
                        html = buildFilterForm();
                        break;

                    case 'show-describe':
                        title = 'Estadísticas descriptivas';
                        // No necesita configuración adicional
                        html = '<p>Mostrando estadísticas descriptivas para todas las columnas numéricas.</p>';
                        break;
                }
                
                document.getElementById('config-title').textContent = title;
                configForm.innerHTML = html;

                // Si es la acción de estadísticas, ejecutamos directamente
                if (action === 'show-describe') {
                    handleExecute();
                }
            }

            function buildFilterForm() {
                return `
                    <div class="filter-builder">
                        <div class="filter-row">
                            <select class="form-control" id="filter-column-select">
                                ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                            </select>
                            <select class="form-control" id="filter-operator-select">
                                <option value="==">igual a</option>
                                <option value="!=">diferente de</option>
                                <option value=">">mayor que</option>
                                <option value="<">menor que</option>
                                <option value=">=">mayor o igual que</option>
                                <option value="<=">menor o igual que</option>
                                <option value="contains">contiene</option>
                                <option value="startsWith">comienza con</option>
                                <option value="endsWith">termina con</option>
                            </select>
                            <input type="text" class="form-control" id="filter-value-input" placeholder="Valor">
                        </div>
                        <div class="filter-preview" id="filter-preview">
                            Filtro: ninguno aplicado
                        </div>
                        <div class="filter-actions">
                            <button type="button" class="btn btn-outline" id="add-filter-btn">
                                <i class="fas fa-plus"></i> Añadir Filtro
                            </button>
                        </div>
                    </div>
                `;
            }

            function handleExecute() {
                const formData = new FormData(configForm);
                const params = {};
                
                for (let [key, value] of formData.entries()) {
                    params[key] = value;
                }
                
                // Simular procesamiento (en una app real harías una petición al servidor)
                let resultData = { ...currentData };
                
                switch(currentAction) {
                    case 'show-head':
                        const rowsHead = parseInt(params.rows) || 10;
                        resultData.data = currentData.data.slice(0, rowsHead);
                        break;
                        
                    case 'show-tail':
                        const rowsTail = parseInt(params.rows) || 10;
                        resultData.data = currentData.data.slice(-rowsTail);
                        break;
                        
                    case 'select-column':
                        const colIndex = currentData.columns.indexOf(params.column);
                        if (colIndex >= 0) {
                            resultData.columns = [params.column];
                            resultData.data = currentData.data.map(row => [row[colIndex]]);
                        }
                        break;
                        
                    case 'filter-data':
                        // En una implementación real, esto se haría con Pandas en el backend
                        alert('Filtrado simulado - En una implementación real esto se procesaría en el servidor');
                        break;

                    case 'show-describe':
                        // Mostrar estadísticas descriptivas
                        showDescriptiveStats();
                        return;
                }
                
                // Mostrar resultados
                loadDataPanel.style.display = 'none';
                dataPreviewPanel.style.display = 'block';
                configPanel.style.display = 'none';
                
                showDataPreview(resultData);
            }

            function showDescriptiveStats() {
                // Simular cálculo de estadísticas descriptivas
                const numericColumns = [];
                const columnTypes = {};
                
                // Determinar qué columnas son numéricas
                if (currentData.data.length > 0) {
                    currentData.columns.forEach((col, colIndex) => {
                        const sampleValue = currentData.data[0][colIndex];
                        if (typeof sampleValue === 'number') {
                            numericColumns.push(col);
                            columnTypes[col] = 'number';
                        } else {
                            columnTypes[col] = 'string';
                        }
                    });
                }
                
                // Calcular estadísticas para cada columna numérica
                const stats = {};
                numericColumns.forEach(col => {
                    const colIndex = currentData.columns.indexOf(col);
                    const values = currentData.data.map(row => row[colIndex]).filter(val => val !== null && val !== undefined);
                    
                    if (values.length > 0) {
                        const sorted = [...values].sort((a, b) => a - b);
                        const sum = values.reduce((a, b) => a + b, 0);
                        const mean = sum / values.length;
                        const min = sorted[0];
                        const max = sorted[sorted.length - 1];
                        const median = sorted.length % 2 === 0 ? 
                            (sorted[sorted.length/2 - 1] + sorted[sorted.length/2]) / 2 : 
                            sorted[Math.floor(sorted.length/2)];
                        
                        // Calcular moda
                        const frequency = {};
                        let maxFreq = 0;
                        let modes = [];
                        values.forEach(val => {
                            frequency[val] = (frequency[val] || 0) + 1;
                            if (frequency[val] > maxFreq) {
                                maxFreq = frequency[val];
                                modes = [val];
                            } else if (frequency[val] === maxFreq) {
                                modes.push(val);
                            }
                        });
                        
                        stats[col] = {
                            count: values.length,
                            mean: mean.toFixed(2),
                            median: median.toFixed(2),
                            mode: modes.length > 3 ? 'Múltiples modas' : modes.join(', '),
                            min: min.toFixed(2),
                            max: max.toFixed(2),
                            range: (max - min).toFixed(2)
                        };
                    }
                });
                
                // Mostrar estadísticas en el panel de vista previa
                loadDataPanel.style.display = 'none';
                dataPreviewPanel.style.display = 'block';
                configPanel.style.display = 'none';
                
                // Limpiar tabla
                dataTable.innerHTML = '';
                
                // Crear encabezados para la tabla de estadísticas
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const statHeaders = ['', 'Count', 'Mean', 'Median', 'Mode', 'Min', 'Max', 'Range'];
                statHeaders.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                dataTable.appendChild(thead);
                
                // Crear cuerpo de la tabla de estadísticas
                const tbody = document.createElement('tbody');
                
                Object.keys(stats).forEach(col => {
                    const tr = document.createElement('tr');
                    
                    // Nombre de la columna
                    const nameTd = document.createElement('td');
                    nameTd.textContent = col;
                    nameTd.style.fontWeight = '500';
                    tr.appendChild(nameTd);
                    
                    // Valores estadísticos
                    const statValues = ['count', 'mean', 'median', 'mode', 'min', 'max', 'range'];
                    statValues.forEach(stat => {
                        const td = document.createElement('td');
                        td.textContent = stats[col][stat];
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                dataTable.appendChild(tbody);
                
                // Mostrar gráficos para las columnas numéricas
                showStatsCharts(numericColumns);
            }

            function showStatsCharts(numericColumns) {
                // Limpiar contenedor de estadísticas
                statsContainer.innerHTML = '';
                
                // Mostrar estadísticas básicas
                const basicStatsHtml = `
                    <div class="stat-card">
                        <h3>Filas</h3>
                        <p>${currentData.data.length}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Columnas</h3>
                        <p>${currentData.columns.length}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Columnas numéricas</h3>
                        <p>${numericColumns.length}</p>
                    </div>
                `;
                
                statsContainer.innerHTML = basicStatsHtml;
                statsContainer.style.display = 'grid';
                showStatsBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar estadísticas';
                
                // Crear gráficos para cada columna numérica
                numericColumns.forEach(col => {
                    const colIndex = currentData.columns.indexOf(col);
                    const values = currentData.data.map(row => row[colIndex]).filter(val => val !== null && val !== undefined);
                    
                    if (values.length > 0) {
                        // Crear contenedor para el gráfico
                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-card';
                        
                        const chartTitle = document.createElement('div');
                        chartTitle.className = 'chart-title';
                        chartTitle.textContent = `Distribución de ${col}`;
                        chartContainer.appendChild(chartTitle);
                        
                        const canvas = document.createElement('canvas');
                        canvas.id = `chart-${col}`;
                        canvas.height = 300;
                        chartContainer.appendChild(canvas);
                        
                        // Añadir al contenedor de estadísticas
                        statsContainer.appendChild(chartContainer);
                        
                        // Crear el gráfico
                        createColumnChart(col, values);
                    }
                });
            }

            function createColumnChart(columnName, values) {
                const ctx = document.getElementById(`chart-${columnName}`);
                
                // Destruir gráfico existente si hay uno
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                
                // Crear histograma
                const min = Math.min(...values);
                const max = Math.max(...values);
                const range = max - min;
                const binSize = range / 10;
                
                const bins = Array(10).fill(0);
                values.forEach(val => {
                    const binIndex = Math.min(Math.floor((val - min) / binSize), 9);
                    bins[binIndex]++;
                });
                
                const labels = Array(10).fill().map((_, i) => {
                    const start = min + i * binSize;
                    const end = start + binSize;
                    return `${start.toFixed(1)}-${end.toFixed(1)}`;
                });
                
                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Frecuencia de ${columnName}`,
                            data: bins,
                            backgroundColor: 'rgba(67, 97, 238, 0.7)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frecuencia'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Rango de valores'
                                }
                            }
                        }
                    }
                });
            }

            function handleCancel() {
                if (currentData) {
                    loadDataPanel.style.display = 'none';
                    dataPreviewPanel.style.display = 'block';
                    configPanel.style.display = 'none';
                } else {
                    document.querySelector('[data-action="load-data"]').click();
                }
            }

            function handleChangeDataset() {
                currentData = null;
                currentSource = null;
                dataSourceInfo.style.display = 'none';
                document.querySelector('[data-action="load-data"]').click();
            }

            function toggleStats() {
                if (statsContainer.style.display === 'none') {
                    // Mostrar estadísticas básicas
                    const numericColumns = [];
                    
                    if (currentData.data.length > 0) {
                        currentData.columns.forEach((col, colIndex) => {
                            const sampleValue = currentData.data[0][colIndex];
                            if (typeof sampleValue === 'number') {
                                numericColumns.push(col);
                            }
                        });
                    }
                    
                    showStatsCharts(numericColumns);
                } else {
                    statsContainer.style.display = 'none';
                    showStatsBtn.innerHTML = '<i class="fas fa-chart-pie"></i> Estadísticas';
                }
            }

            function parseCSV(data) {
                // Parseo simple de CSV (en una app real usarías una librería)
                const lines = data.split('\n');
                const columns = lines[0].split(',');
                const rows = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const row = lines[i].split(',');
                        // Intentar convertir valores numéricos
                        const processedRow = row.map(cell => {
                            const num = parseFloat(cell);
                            return isNaN(num) ? cell : num;
                        });
                        rows.push(processedRow);
                    }
                }
                
                return {
                    columns: columns,
                    data: rows
                };
            }

            function handleCleaningCardClick() {
                cleaningCards.forEach(card => card.classList.remove('active'));
                this.classList.add('active');
                
                cleaningAction = this.getAttribute('data-action');
                showCleaningForm(cleaningAction);
            }

            function showCleaningOptions() {
                cleaningFormContainer.style.display = 'none';
                cleaningCards.forEach(card => card.classList.remove('active'));
            }

            function showCleaningForm(action) {
                cleaningForm.innerHTML = '';
                
                switch(action) {
                    case 'fill-na':
                        cleaningForm.innerHTML = `
                            <div class="form-group">
                                <label>Columna:</label>
                                <select class="form-control" name="column">
                                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Valor de reemplazo:</label>
                                <input type="text" class="form-control" name="fill-value" placeholder="0, 'N/A', media, etc.">
                            </div>
                        `;
                        break;
                        
                    case 'drop-na':
                        cleaningForm.innerHTML = `
                            <div class="form-group">
                                <label>Columnas a verificar (dejar vacío para todas):</label>
                                <select class="form-control" name="columns" multiple>
                                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Umbral (máximo % de valores faltantes permitidos por fila):</label>
                                <input type="number" class="form-control" name="threshold" min="0" max="100" value="100" step="5">
                                <small class="text-muted">100% = eliminar solo filas con todos los valores faltantes</small>
                            </div>
                        `;
                        break;
                        
                    case 'drop-duplicates':
                        cleaningForm.innerHTML = `
                            <div class="form-group">
                                <label>Columnas a considerar (dejar vacío para todas):</label>
                                <select class="form-control" name="columns" multiple>
                                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Opciones:</label>
                                <div>
                                    <input type="checkbox" id="keep-first" name="keep-first" checked>
                                    <label for="keep-first">Mantener primera ocurrencia</label>
                                </div>
                            </div>
                        `;
                        break;
                        
                    case 'convert-types':
                        cleaningForm.innerHTML = `
                            <div class="form-group">
                                <label>Columna:</label>
                                <select class="form-control" name="column">
                                    ${currentData.columns.map(col => `<option value="${col}">${col}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de dato:</label>
                                <select class="form-control" name="type">
                                    <option value="number">Número</option>
                                    <option value="string">Texto</option>
                                    <option value="boolean">Booleano</option>
                                    <option value="date">Fecha</option>
                                </select>
                            </div>
                        `;
                        break;
                }
                
                cleaningFormContainer.style.display = 'block';
            }

            function handleApplyCleaning() {
                // Simular la aplicación de limpieza de datos
                alert(`Acción de limpieza "${cleaningAction}" aplicada (simulado)`);
                
                // En una implementación real, enviarías los datos al servidor para procesamiento
                // y recibirías el dataset limpio de vuelta
                
                // Volver a mostrar las opciones de limpieza
                showCleaningOptions();
            }

            function handleCancelCleaning() {
                showCleaningOptions();
            }

            function setupVisualizationPanel() {
                // Limpiar selects
                xAxisSelect.innerHTML = '';
                yAxisSelect.innerHTML = '';
                colorBySelect.innerHTML = '';
                
                // Poblar selects con columnas disponibles
                currentData.columns.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col;
                    option.textContent = col;
                    xAxisSelect.appendChild(option.cloneNode(true));
                    yAxisSelect.appendChild(option.cloneNode(true));
                    colorBySelect.appendChild(option.cloneNode(true));
                });
                
                // Actualizar controles según el tipo de gráfico
                updateChartControls();
                
                // Crear gráfico inicial
                updateChart();
            }

            function updateChartControls() {
                const chartType = chartTypeSelect.value;
                
                // Mostrar/ocultar controles según el tipo de gráfico
                xAxisGroup.style.display = 'block';
                
                if (chartType === 'scatter' || chartType === 'line') {
                    yAxisGroup.style.display = 'block';
                } else {
                    yAxisGroup.style.display = 'none';
                }
                
                if (chartType === 'pie' || chartType === 'bar') {
                    colorGroup.style.display = 'block';
                } else {
                    colorGroup.style.display = 'none';
                }
            }

            function updateChart() {
                const chartType = chartTypeSelect.value;
                const xCol = xAxisSelect.value;
                const yCol = yAxisSelect.value;
                const colorCol = colorBySelect.value;
                
                const xIndex = currentData.columns.indexOf(xCol);
                const yIndex = currentData.columns.indexOf(yCol);
                const colorIndex = currentData.columns.indexOf(colorCol);
                
                if (xIndex === -1) return;
                
                // Obtener datos para el eje X
                const xValues = currentData.data.map(row => row[xIndex]);
                
                // Configurar datos según el tipo de gráfico
                let chartData = {};
                
                if (chartType === 'histogram') {
                    chartData = createHistogramData(xValues, xCol);
                } else if (chartType === 'bar') {
                    chartData = createBarChartData(xValues, colorIndex, xCol, colorCol);
                } else if (chartType === 'pie') {
                    chartData = createPieChartData(xValues, colorIndex, xCol, colorCol);
                } else if (chartType === 'scatter' || chartType === 'line') {
                    if (yIndex === -1) return;
                    const yValues = currentData.data.map(row => row[yIndex]);
                    chartData = createScatterLineData(xValues, yValues, xCol, yCol, chartType);
                } else if (chartType === 'box') {
                    chartData = createBoxPlotData(xValues, xCol);
                }
                
                // Crear o actualizar el gráfico
                if (dataChart) {
                    dataChart.destroy();
                }
                
                dataChart = new Chart(chartCanvas, {
                    type: chartType === 'histogram' ? 'bar' : chartType,
                    data: chartData.data,
                    options: chartData.options
                });
            }

            function createHistogramData(values, label) {
                // Calcular bins para el histograma
                const min = Math.min(...values);
                const max = Math.max(...values);
                const range = max - min;
                const binSize = range / 10;
                
                const bins = Array(10).fill(0);
                values.forEach(val => {
                    const binIndex = Math.min(Math.floor((val - min) / binSize), 9);
                    bins[binIndex]++;
                });
                
                const binLabels = Array(10).fill().map((_, i) => {
                    const start = min + i * binSize;
                    const end = start + binSize;
                    return `${start.toFixed(1)}-${end.toFixed(1)}`;
                });
                
                return {
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: `Frecuencia de ${label}`,
                            data: bins,
                            backgroundColor: 'rgba(67, 97, 238, 0.7)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frecuencia'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Rango de valores'
                                }
                            }
                        }
                    }
                };
            }

            function createBarChartData(values, colorIndex, xLabel, colorLabel) {
                // Agrupar valores por categoría de color si se seleccionó
                let datasets = [];
                
                if (colorIndex >= 0) {
                    const categories = {};
                    currentData.data.forEach((row, i) => {
                        const category = row[colorIndex] || 'Sin categoría';
                        if (!categories[category]) {
                            categories[category] = {
                                label: category,
                                data: Array(values.length).fill(0),
                                backgroundColor: getRandomColor()
                            };
                        }
                        categories[category].data[i] = values[i];
                    });
                    
                    datasets = Object.values(categories);
                } else {
                    datasets = [{
                        label: xLabel,
                        data: values,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)'
                    }];
                }
                
                return {
                    data: {
                        labels: Array(values.length).fill().map((_, i) => `Item ${i+1}`),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                };
            }

            function createPieChartData(values, colorIndex, xLabel, colorLabel) {
                // Agrupar valores para el gráfico de torta
                const counts = {};
                values.forEach(val => {
                    counts[val] = (counts[val] || 0) + 1;
                });
                
                const labels = Object.keys(counts);
                const data = Object.values(counts);
                const backgroundColors = labels.map(() => getRandomColor());
                
                return {
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors
                        }]
                    },
                    options: {
                        responsive: true
                    }
                };
            }

            function createScatterLineData(xValues, yValues, xLabel, yLabel, chartType) {
                // Crear datos para gráfico de dispersión o líneas
                const points = xValues.map((x, i) => ({x, y: yValues[i]}));
                
                return {
                    data: {
                        datasets: [{
                            label: `${yLabel} vs ${xLabel}`,
                            data: points,
                            backgroundColor: 'rgba(67, 97, 238, 0.7)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            pointRadius: chartType === 'line' ? 3 : 5,
                            showLine: chartType === 'line'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xLabel
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yLabel
                                }
                            }
                        }
                    }
                };
            }

            function createBoxPlotData(values, label) {
                // Calcular estadísticas para el diagrama de caja
                const sorted = [...values].sort((a, b) => a - b);
                const q1 = sorted[Math.floor(sorted.length * 0.25)];
                const median = sorted[Math.floor(sorted.length * 0.5)];
                const q3 = sorted[Math.floor(sorted.length * 0.75)];
                const iqr = q3 - q1;
                const min = Math.max(sorted[0], q1 - 1.5 * iqr);
                const max = Math.min(sorted[sorted.length - 1], q3 + 1.5 * iqr);
                
                return {
                    data: {
                        labels: [label],
                        datasets: [{
                            label: label,
                            data: [{
                                min: min,
                                q1: q1,
                                median: median,
                                q3: q3,
                                max: max
                            }],
                            backgroundColor: 'rgba(67, 97, 238, 0.5)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Valores'
                                }
                            }
                        }
                    }
                };
            }

            function getRandomColor() {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
        });
    </script>
</body>
</html>